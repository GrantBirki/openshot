name: release

on:
  push:
    branches:
      - main
    paths:
      - "VERSION"

permissions: {}

jobs:
  build:
    if: github.repository == 'grantbirki/oneshot' # change this to your repository
    permissions:
      contents: read
      id-token: write
      attestations: write
    runs-on: macos-latest
    outputs:
      artifact-id: ${{ steps.upload-artifact.outputs.artifact-id }}
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}

    steps:
      - name: checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # pin@v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: read version
        id: version
        run: |
          version=$(awk 'NF && $1 !~ /^#/ {print $1; exit}' VERSION)
          if [[ -z "$version" ]]; then
            echo "VERSION file is empty."
            exit 1
          fi

          if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "VERSION must be in X.Y.Z format; got ${version}."
            exit 1
          fi

          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag=v$version" >> "$GITHUB_OUTPUT"

      - name: install xcodegen
        run: |
          export HOMEBREW_NO_AUTO_UPDATE=1
          export HOMEBREW_NO_INSTALL_CLEANUP=1
          brew install xcodegen

      - name: package
        run: script/package

      - name: scan artifact for tokens
        run: |
          artifact="dist/OneShot.zip"
          if [[ ! -f "$artifact" ]]; then
            echo "Expected artifact not found at $artifact"
            exit 1
          fi

          scan_dir="$(mktemp -d)"
          trap 'rm -rf "$scan_dir"' EXIT
          ditto -x -k "$artifact" "$scan_dir"

          if grep -R -a -E -n 'gh[pousr]_[A-Za-z0-9_]{20,}|github_pat_[A-Za-z0-9_]{20,}' "$scan_dir" >/dev/null; then
            echo "Potential token found in release artifact (file paths only):"
            grep -R -a -E -l 'gh[pousr]_[A-Za-z0-9_]{20,}|github_pat_[A-Za-z0-9_]{20,}' "$scan_dir"
            exit 1
          fi

      - name: attest build provenance
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # pin@v3.1.0
        with:
          subject-path: "dist/OneShot.zip"

      - name: upload artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # pin@v6.0.0
        id: upload-artifact
        with:
          name: dist
          path: dist/
          retention-days: 5
          if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # pin@v6.0.1
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # pin@7.0.0
        with:
          artifact-ids: ${{ needs.build.outputs.artifact-id }}
          path: "dist/"

      - name: ensure tag does not exist
        env:
          TAG: ${{ needs.build.outputs.tag }}
        run: |
          if git rev-parse "refs/tags/${TAG}" >/dev/null 2>&1; then
            echo "Tag already exists: ${TAG}"
            exit 1
          fi

      - name: create release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # pin@v2.5.0
        with:
          tag_name: ${{ needs.build.outputs.tag }}
          name: ${{ needs.build.outputs.tag }}
          target_commitish: ${{ github.sha }}
          files: |
            dist/OneShot.zip
            dist/OneShot.zip.sha256
          generate_release_notes: true

  verify:
    permissions: {}
    runs-on: ubuntu-latest
    needs: [build, release]
    steps:
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # pin@7.0.0
        with:
          artifact-ids: ${{ needs.build.outputs.artifact-id }}
          path: "dist/"

      - name: verify
        env:
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          ARTIFACT_PATH: "dist/OneShot.zip"
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOURCE_REF: refs/heads/${{ github.ref_name }}
        run: |
          if [[ ! -f "$ARTIFACT_PATH" ]]; then
            echo "Expected artifact not found at $ARTIFACT_PATH"
            exit 1
          fi

          if [[ ! -f "${ARTIFACT_PATH}.sha256" ]]; then
            echo "Expected checksum not found at ${ARTIFACT_PATH}.sha256"
            exit 1
          fi

          expected_sha=$(cat "${ARTIFACT_PATH}.sha256")
          actual_sha=$(shasum -a 256 "$ARTIFACT_PATH" | awk '{print $1}')
          if [[ "$expected_sha" != "$actual_sha" ]]; then
            echo "Checksum mismatch: expected $expected_sha but got $actual_sha"
            exit 1
          fi

          gh attestation verify "$ARTIFACT_PATH" \
            --repo "${OWNER}/${REPO}" \
            --signer-workflow "${OWNER}/${REPO}/.github/workflows/release.yml" \
            --source-ref "$SOURCE_REF" \
            --deny-self-hosted-runners

  release_info:
    permissions: {}
    runs-on: ubuntu-latest
    needs: [build, release, verify]
    if: ${{ always() }}
    steps:
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # pin@7.0.0
        with:
          artifact-ids: ${{ needs.build.outputs.artifact-id }}
          path: "dist/"

      - name: print tap update info
        env:
          VERSION: ${{ needs.build.outputs.version }}
        run: |
          sha_file="dist/OneShot.zip.sha256"
          if [[ ! -f "$sha_file" ]]; then
            echo "Release info unavailable: expected checksum not found at $sha_file"
            exit 0
          fi

          sha=$(cat "$sha_file")
          if [[ ! "$sha" =~ ^[0-9a-fA-F]{64}$ ]]; then
            echo "Release info unavailable: invalid SHA256 in $sha_file"
            exit 0
          fi

          green='\033[0;32m'
          blue='\033[0;34m'
          yellow='\033[0;33m'
          off='\033[0m'

          echo -e "${green}Homebrew tap update details:${off}"
          echo -e "  ${blue}version${off}: ${VERSION}"
          echo -e "  ${blue}sha256${off}: ${sha}"
          echo
          echo -e "${yellow}Cask snippet:${off}"
          cat <<RUBY
          cask "oneshot" do
            version "${VERSION}"
            sha256 "${sha}"

            url "https://github.com/grantbirki/oneshot/releases/download/v#{version}/OneShot.zip"
            name "OneShot"
            desc "Open source screenshot utility for macOS"
            homepage "https://github.com/grantbirki/oneshot"

            app "OneShot.app"
          end
          RUBY

          {
            echo "## Homebrew tap update details"
            echo
            echo "- version: \`${VERSION}\`"
            echo "- sha256: \`${sha}\`"
            echo
            echo "Cask snippet:"
            echo
            echo '```rb'
            cat <<RUBY
cask "oneshot" do
  version "${VERSION}"
  sha256 "${sha}"

  url "https://github.com/grantbirki/oneshot/releases/download/v#{version}/OneShot.zip"
  name "OneShot"
  desc "Open source screenshot utility for macOS"
  homepage "https://github.com/grantbirki/oneshot"

  app "OneShot.app"
end
RUBY
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"
