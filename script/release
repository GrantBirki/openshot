#!/usr/bin/env bash

set -euo pipefail

# Usage:
# script/release

source script/env "$@"
source "$DIR/script/lib/common.sh"

require_macos error "Release requires macOS."
require_tool xcodebuild "xcodebuild not found. Install Xcode or Command Line Tools."
require_tool ditto "ditto not found."
set_xcodebuild_vars

if [[ "$VERSION" == "unknown" ]]; then
  echo -e "${RED}VERSION file missing or invalid.${OFF}"
  exit 1
fi

if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
  echo -e "${RED}ERROR${OFF} - VERSION must be in X.Y.Z format."
  exit 1
fi

echo -e "Release version: ${BLUE}${VERSION}${OFF}"

script/package

SHA_FILE="$DIR/dist/${APP_NAME}.zip.sha256"
if [[ ! -f "$SHA_FILE" ]]; then
  echo -e "${RED}Release checksum not found at $SHA_FILE${OFF}"
  exit 1
fi

SHA=$(cat "$SHA_FILE")
if [[ ! "$SHA" =~ ^[0-9a-fA-F]{64}$ ]]; then
  echo -e "${RED}Invalid SHA256 in $SHA_FILE${OFF}"
  exit 1
fi

echo -e "${GREEN}DONE${OFF}"
