#!/usr/bin/env bash

set -euo pipefail

# Usage:
# script/release

source script/env "$@"
source "$DIR/script/lib/common.sh"

require_macos error "Release requires macOS."
require_tool xcodebuild "xcodebuild not found. Install Xcode or Command Line Tools."
require_tool ditto "ditto not found."
require_tool python3 "python3 not found."

set_xcodebuild_vars

VERSION_FILE="$DIR/VERSION"
VERSION_COMMENT='# DO NOT EDIT THIS FILE DIRECTLY, USE `script/release` instead'
CASK_FILE="$DIR/Casks/oneshot.rb"

if [[ "$VERSION" == "unknown" ]]; then
  echo -e "${RED}VERSION file missing or invalid.${OFF}"
  exit 1
fi

echo -e "Current version: ${BLUE}${VERSION}${OFF}"
read -r -p 'New version (X.Y.Z format): ' new_version

if [[ ! "$new_version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
  echo -e "${RED}ERROR${OFF} - Version: $new_version is not valid. Please use X.Y.Z format."
  exit 1
fi

if [[ "$new_version" == "$VERSION" ]]; then
  echo -e "${RED}ERROR${OFF} - Version is unchanged."
  exit 1
fi

printf "%s\n%s\n" "$VERSION_COMMENT" "$new_version" > "$VERSION_FILE"
echo -e "${GREEN}OK${OFF} - Updated VERSION to ${new_version}"

script/package

SHA_FILE="$DIR/dist/${APP_NAME}.zip.sha256"
if [[ ! -f "$SHA_FILE" ]]; then
  echo -e "${RED}Release checksum not found at $SHA_FILE${OFF}"
  exit 1
fi

SHA=$(cat "$SHA_FILE")
if [[ ! "$SHA" =~ ^[0-9a-fA-F]{64}$ ]]; then
  echo -e "${RED}Invalid SHA256 in $SHA_FILE${OFF}"
  exit 1
fi

if [[ ! -f "$CASK_FILE" ]]; then
  echo -e "${RED}Cask not found at $CASK_FILE${OFF}"
  exit 1
fi

ONESHOT_SHA="$SHA" ONESHOT_CASK="$CASK_FILE" python3 - <<'PY'
import os
import re
from pathlib import Path

sha = os.environ["ONESHOT_SHA"]
path = Path(os.environ["ONESHOT_CASK"])
text = path.read_text()
new_text, count = re.subn(r'^  sha256 ".*"$', f'  sha256 "{sha}"', text, flags=re.M)
if count != 1:
    raise SystemExit("Failed to update sha256 in cask.")
path.write_text(new_text)
PY


echo -e "${GREEN}OK${OFF} - Updated cask sha256"
echo -e "${GREEN}DONE${OFF}"
