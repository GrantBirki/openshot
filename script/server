#!/usr/bin/env bash

set -euo pipefail

source script/env "$@"
source "$DIR/script/lib/common.sh"

require_macos error "Launch requires macOS."

script/build

APP_NAME="${APP_NAME:-OneShot}"
CONFIGURATION="${CONFIGURATION:-Debug}"
DERIVED_DATA="${DERIVED_DATA:-$DIR/build/DerivedData}"
APP_PATH="$DERIVED_DATA/Build/Products/$CONFIGURATION/$APP_NAME.app"
APP_EXEC="$APP_PATH/Contents/MacOS/$APP_NAME"
BUNDLE_ID_DEFAULT="com.grantbirki.oneshot"
if [[ "$CONFIGURATION" == "Debug" ]]; then
  BUNDLE_ID_DEFAULT="com.grantbirki.oneshot.dev"
fi
BUNDLE_ID="${BUNDLE_ID:-$BUNDLE_ID_DEFAULT}"

if pgrep -f "$APP_EXEC" >/dev/null 2>&1; then
  echo -e "${BLUE}Quitting existing ${APP_NAME}...${OFF}"
  osascript -e "tell application id \"$BUNDLE_ID\" to quit" >/dev/null 2>&1 || true
  sleep 0.5
  pkill -f "$APP_EXEC" >/dev/null 2>&1 || true
fi

if [[ ! -d "$APP_PATH" ]]; then
  echo -e "${RED}App not found at ${APP_PATH}.${OFF}"
  exit 1
fi

echo "Tip: you can stream logs with:"
echo "log stream --predicate 'process == \"OneShot\"' --style compact"
echo "Or you can use:"
echo "log stream --level debug --predicate 'subsystem == \"com.grantbirki.oneshot\"'"
echo -e "${GREEN}Launching ${APP_NAME}...${OFF}"
open "$APP_PATH"
